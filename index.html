<script>
    // 1. YOUR CREDENTIALS
    const KEY = "AIzaSyAU90lMJSHKKhs2iG7nadi847LXAoAW0jA";
    const MODEL = "gemini-1.5-flash"; 

    async function executeSabrina() {
        const input = document.getElementById('user-input');
        const flow = document.getElementById('chat-flow');
        const query = input.value.trim();
        
        if(!query) return; // Don't send empty messages

        // 2. DISPLAY USER MESSAGE
        flow.innerHTML += `<div class="bubble user">${query}</div>`;
        input.value = ""; // Clear the input box
        flow.scrollTop = flow.scrollHeight; // Scroll to bottom

        // 3. CREATE LOADING BUBBLE
        const aiDiv = document.createElement('div');
        aiDiv.className = 'bubble ai';
        aiDiv.innerHTML = `<div class="thinking-banner">Sabrina is analyzing...</div><span class="loading">Processing logic...</span>`;
        flow.appendChild(aiDiv);

        try {
            // 4. FETCH DATA (THE JAVASCRIPT CALL)
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: "You are Sabrina, an elite AI. Answer this: " + query }] }]
                })
            });

            const data = await response.json();

            // 5. EXTRACT THE TEXT
            // This is where the old code was failing. We must find the text inside 'candidates'
            if(data.candidates && data.candidates[0].content) {
                const aiText = data.candidates[0].content.parts[0].text;
                
                // 6. UPDATE UI WITH REAL ANSWER
                aiDiv.innerHTML = `<div class="thinking-banner">Logic Finalized</div>${marked.parse(aiText)}`;
            } else {
                aiDiv.innerHTML = "Sabrina: I couldn't process that. Check your API settings.";
            }

        } catch (error) {
            aiDiv.innerHTML = "Sabrina: Connection error. Ensure you are using a web server.";
            console.error("JavaScript Error:", error);
        }
        
        flow.scrollTop = flow.scrollHeight;
    }

    // Allow pressing "Enter" to send
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            executeSabrina();
        }
    });
</script>
